# Example ESPHome configuration for Elecrow CrowPanel ESP32 2.9" E-Paper
# 
# This example shows a basic clock display with date.
# Customize the lambda section to display your own content.

esphome:
  name: crowpanel-epaper
  friendly_name: CrowPanel E-Paper 2.9"
  platformio_options:
    build_flags: "-DBOARD_HAS_PSRAM"
    board_build.esp-idf.memory_type: qio_opi
    board_build.flash_mode: dio


esp32:
  board: esp32s3box
  framework:
    type: esp-idf
    sdkconfig_options:
      CONFIG_ESP32S3_DEFAULT_CPU_FREQ_240: y
      CONFIG_ESP32S3_DATA_CACHE_64KB: y
      CONFIG_SPIRAM_FETCH_INSTRUCTIONS: y
      CONFIG_SPIRAM_RODATA: y

psram:
  mode: octal
  speed: 80MHz

logger:
  level: DEBUG

api:
  encryption:
    key: !secret api_encryption_key

ota:
  - platform: esphome
    password: !secret ota_password

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password


# Include the SSD1680 component from GitHub
external_components:
  - source:
      type: git
      url: https://github.com/apadua/esphome-ssd1680
      ref: main
    components: [ssd1680_epaper]

# SPI bus configuration for CrowPanel
spi:
  clk_pin: GPIO12
  mosi_pin: GPIO11

# E-Paper Display configuration
display:
  - platform: ssd1680_epaper
    id: epaper_display
    cs_pin:
      number: GPIO45
      ignore_strapping_warning: true
    dc_pin:
      number: GPIO46
      ignore_strapping_warning: true
    reset_pin: GPIO47
    busy_pin: GPIO48
    rotation: 270  # Landscape mode
    update_interval: 60s
    lambda: |-
      // Fill with white background
      it.fill(COLOR_OFF);
      
      // Title
      it.printf(it.get_width()/2, 5, id(font_title), COLOR_ON, TextAlign::TOP_CENTER, "My E-Paper");
      
      // Display time
      if (id(sntp_time).now().is_valid()) {
        // Large time
        it.strftime(it.get_width()/2, 35, id(font_huge), COLOR_ON, TextAlign::TOP_CENTER, "%H:%M", id(sntp_time).now());
        
        // Day of week
        it.strftime(it.get_width()/2, 90, id(font_medium), COLOR_ON, TextAlign::TOP_CENTER, "%A", id(sntp_time).now());
        
        // Date
        it.strftime(it.get_width()/2, 115, id(font_small), COLOR_ON, TextAlign::TOP_CENTER, "%B %d, %Y", id(sntp_time).now());
      } else {
        it.printf(it.get_width()/2, 60, id(font_medium), COLOR_ON, TextAlign::TOP_CENTER, "Waiting for time...");
      }

# Fonts
font:
  - file: "gfonts://Roboto@700"
    id: font_title
    size: 20
  - file: "gfonts://Roboto@700"
    id: font_huge
    size: 48
  - file: "gfonts://Roboto@500"
    id: font_medium
    size: 20
  - file: "gfonts://Roboto@400"
    id: font_small
    size: 16

# Time source
time:
  - platform: sntp
    id: sntp_time
    timezone: America/New_York
    servers:
      - 0.pool.ntp.org
      - 1.pool.ntp.org
      - 2.pool.ntp.org

# Optional: Button to force display refresh
binary_sensor:
  - platform: gpio
    pin:
      number: GPIO1
      mode: INPUT_PULLUP
      inverted: true
    name: "Exit Button"
    on_press:
      then:
        - logger.log: "Button pressed - refreshing display"
        - component.update: epaper_display

# Optional: Status LED
status_led:
  pin:
    number: GPIO21
    inverted: true

# Optional: Interval for regular logging
interval:
  - interval: 30s
    then:
      - logger.log: "Heartbeat - device is running"
